<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>MelodyPlotter</title>
</head>
<body>
    <p id="notes">TAP TO START</p>
    <script>

var notes = document.getElementById('notes');
var context;
var analyzer;
var binCount = 2048;
var binSize;
var buffer = new Uint8Array(binCount);

var pitches = [
    '?', '?', '?', '?', '?', '?', '?', '?', '?', '?', 
    '?', '?', 'C4', '?', 'D4', 'E4', 'F4', 'F#4', 'G4', '?', 
    'A4', '?', '?', 'B4', '?', '?', '?', '?', '?', '?', 
    '?', '?', '?', '?', '?', '?', '?', '?', '?', '?', 
    '?', '?', '?', '?', '?', '?', '?', '?', '?', '?', 
    '?', '?', '?', '?', '?', '?', '?', '?', '?', '?', 
    '?', '?', '?', '?', '?', '?', '?', '?', '?', '?'
]

function setup(stream) {
    context = new (window.AudioContext || window.webkitAudioContext)();
    binSize = (context.sampleRate / 2) / binCount;

    analyser = context.createAnalyser();
    analyser.fftSize = binCount * 2;
    analyser.minDecibels = -90;
    analyser.maxDecibels = -10;

    source = context.createMediaStreamSource(stream);
    source.connect(analyser);

    window.setInterval(transcribe, 10);
}

function transcribe() {
    analyser.getByteFrequencyData(buffer);
    var maxBin = 0;
    var maxLevel = 0;
    for(var bin = 0; bin < binCount; bin++) {
        var level = buffer[bin];
        if (level > maxLevel) {
            maxLevel = level;
            maxBin = bin;
        }
    }
    notes.innerHTML = 'Loudest frequency: ' + (maxBin * binSize)  + ' Hz';
}  

function init() {
    document.body.removeEventListener('click', init)

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({audio: true}).then(setup)
            .catch( err => window.alert('Failed to access audio devices: ' + err) );
    } else {
        window.alert('Audio devices unavailable!');
    }
}

document.body.addEventListener('click', init);

    </script>
	
</body>
</html>
