<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>MelodyPlotter</title>
</head>
<body>
    <button type="button" onclick="startStop()">START/STOP</button>
    <p id="notes"></p>
    <script>

var binCount = 4096;
var binSize;

var notes = document.getElementById('notes');
var initialized = false;
var intervalHandle;
var analyser;

var buffer = new Uint8Array(binCount);
var prevBins = [];


function setup(stream) {
    var context = new (window.AudioContext || window.webkitAudioContext)();
    binSize = (context.sampleRate / 2) / binCount;

    analyser = context.createAnalyser();
    analyser.fftSize = binCount * 2;
    analyser.minDecibels = -90;
    analyser.maxDecibels = -10;

    var source = context.createMediaStreamSource(stream);
    source.connect(analyser);
}

function transcribe() {
    analyser.getByteFrequencyData(buffer);
    var maxBin = 0;
    var maxLevel = 0;
    var levelSum = 0;
    for(var bin = 0; bin < binCount; bin++) {
        var level = buffer[bin];
        levelSum += level;
        if (level > maxLevel) {
            maxLevel = level;
            maxBin = bin;
        }
    }
    var mean = levelSum / binCount;
    if (maxLevel < mean * 1.5) {
        return;
    }
    prevBins.push(maxBin);
    var frequency = parseInt(maxBin * binSize);
    notes.innerHTML = 'Frequency: ~' + frequency  + ' Hz, bin: ' + maxBin + ', level: ' + maxLevel + ', mean: ' + mean;
}  

async function startStop() {

    if (intervalHandle) {
        window.clearInterval(intervalHandle)
        intervalHandle = undefined;
    } else {
        if (!initialized) {
            try {
                var stream = await navigator.mediaDevices.getUserMedia({audio: true});
                setup(stream)
                initialized = true;
            } catch(err) {
                window.alert('Cannot access microphone: ' + err);
                return;
            }
        }
        intervalHandle = window.setInterval(transcribe, 10);
    }
}

    </script>
	
</body>
</html>
